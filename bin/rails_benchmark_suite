#!/usr/bin/env ruby
# frozen_string_literal: true

require "optparse"
require "etc"
$LOAD_PATH.unshift File.expand_path("../lib", __dir__)
require "rails_benchmark_suite"
require "rails_benchmark_suite/version"

config = RailsBenchmarkSuite::Configuration.new

OptionParser.new do |opts|
  opts.banner = "Usage: rails_benchmark_suite [options]"

  opts.on("-v", "--version", "Print version") do
    puts "RailsBenchmarkSuite v#{RailsBenchmarkSuite::VERSION}"
    exit 0
  end

  opts.on("-t", "--threads N", Integer, "Number of threads (default: auto set to #{Etc.nprocessors} cores)") do |n|
    config.threads = n
  end

  opts.on("-p", "--profile", "Enable scaling efficiency profile mode") do
    config.profile = true
  end

  opts.on("-d", "--db", "Use real database from config/database.yml instead of in-memory SQLite") do
    config.db = true
  end

  opts.on("--skip-rails", "Skip Rails environment loading") do
    config.skip_rails = true
  end

  opts.on("-j", "--json", "Output results as JSON") do
    config.json = true
  end

  opts.on("-h", "--help", "Prints this help") do
    puts opts
    exit 0
  end
end.parse!

unless config.json
  puts "RailsBenchmarkSuite v#{RailsBenchmarkSuite::VERSION}"
  puts "Configuration: Threads=#{config.threads} | Profile=#{config.profile} | Local DB=#{config.db}"
end

# Rails Detection
rails_env_path = File.join(Dir.pwd, "config", "environment.rb")

if !config.skip_rails && File.exist?(rails_env_path)
  puts "Rails environment detected at #{rails_env_path}. Loading..." unless config.json
  require rails_env_path
  puts "Rails loaded successfully." unless config.json
else
  unless config.json
    if config.skip_rails
      puts "Skipping Rails loading (requested via --skip-rails)."
    else
      puts "No Rails environment detected (config/environment.rb not found)."
    end
  end
end

RailsBenchmarkSuite::Runner.new(config).run
